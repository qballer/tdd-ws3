{"version":3,"sources":["e2e.spec.js"],"names":[],"mappings":"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","file":"e2e.spec.js","sourcesContent":["require('source-map-support').install();\nvar Promise = require('bluebird');\nvar assert = require('chai').assert;\nimport redis from 'then-redis';\nvar childProcess = require('child_process');\nconst SNIPER_ID = 'sniper';\nconst REDIS_HOSTNAME = 'localhost';\nconst STATUS = 'STATUS';\n\nvar webdriverio = require('webdriverio');\nvar options = { desiredCapabilities: { browserName: 'phantomjs' } };\n\nvar statuses = {\n\tSTATUS_JOINING: 'joining',\n\tSTATUS_LOST: 'lost', \n\tSTATUS_BIDDING: 'bidding'\n}\nvar client;\n\nclass AuctionSniperDriver{\n\t// todo connect with browser to localhost http server, assert that html response shows expected status\n\tconstructor(){\n\t\tclient = webdriverio.remote(options);\n\t\tthis.first = true;\n\t}\n\tshowsSniperStatus(statusText) {\n\t\tif (this.first){\n\t\t\tclient = client.init();\n\t\t\tthis.first = false;\n\t\t}\n\t\treturn client.url('http://localhost:8888')\n\t\t\t\t.then( () => client.getText('#status'))\n\t\t\t\t.then(text => {\n\t\t\t\t\tassert.equal(text, statusText, 'wrong status');\n\t\t\t\t});\n\t}\n\tstop(){\n\t\tclient.end();\n\t}\n}\n\nclass ApplicationRunner {\n\tconstructor() {\n\t\tthis.driver = new AuctionSniperDriver(1000);\n\t}\n\tstartBiddingIn(auction) {\n\t\t// start main program with some arguments\n\t\tthis.runningServer = childProcess.exec('node ./dist/src/main.js ' +  SNIPER_ID + ' ' + auction , (error,stdout) => {\n\t\t\tconsole.log(stdout);\n\t\t\tconsole.log(error);\n\t\t});\n\t\treturn this.driver.showsSniperStatus(statuses.STATUS_JOINING); \n\t}\n\tshowsSniperHasLostAuction () {\n\t\treturn this.driver.showsSniperStatus(statuses.STATUS_LOST);\n\t}\n\n\thasShownSniperIsBidding() {\n\t\treturn this.driver.showsSniperStatus(statuses.STATUS_BIDDING);\n\t}\n\n\tstop(){\n\t\t this.runningServer.kill('SIGINT');\n         this.driver.stop();\n\t}\n\t\n}\n\nclass FakeAuctionServer {\n\tconstructor(itemId) {\n\t\tthis.count = 0;\n\t\tthis.itemId = itemId;\n\t\tthis.redisListener = redis.createClient();\n\t\tthis.redisPublisher = redis.createClient();\n\t\tthis.redisListener.on('message', (channel, msg) => {\n\t\t\t\tthis.count += 1;\n\t\t\t\tthis.message = msg;\n\t\t})\n\t}\n\thasRecievedJoinRequestFromSniper(){\n        assert(this.count > 0, 'did not receive a message');\n        assert.equal(this.message, 'join', 'message mismatch');\n\t\treturn new Promise((res, rej) =>{\n\t\t\tres();\n\t\t});\n\t}\n\t\n\t\n\thasReceivedBid(bid, sniperId) {\n\t\tvar parsedMessage = JSON.parse(this.message);\n\t\tassert.equal(parsedMessage.event,'bid', 'event mismatch');\n\t\tassert.equal(parsedMessage.bidder, sniperId, 'bidder mismatch');\n\t\tassert.equal(parsedMessage.price, bid, 'price mismatch');\n\t\treturn new Promise((res, rej) =>{\n\t\t\tres();\n\t\t});\n\t}\n\t\n\tannounceClosed(){\n\t\treturn this.redisPublisher.publish(this.itemId, JSON.stringify({event:\"closed\"}));\n\t}\n\tstartSellingItem() {\n\t\treturn this.redisListener.subscribe(this.itemId);\n\t}\n\n\treportPrice(price, increment, bidder) {\n\t\treturn this.redisPublisher.publish(this.itemId, JSON.stringify({event:'price', price, increment, bidder}));\n\t}\n}\n\ndescribe('the auction sniper', () =>{\n\tvar auction;\n\tvar application;\n\tbeforeEach('initialize auction server and application runner objects',() => {\n\t\tauction = new FakeAuctionServer('item-5347');\t\t\n\t\tapplication = new ApplicationRunner();\n\t});\n\n\tit('joins an auction untill it closes', () => {\n\t\treturn auction.startSellingItem()\n\t\t\t.then(() => application.startBiddingIn('item-5347'))\n\t\t\t.then(() => auction.hasRecievedJoinRequestFromSniper())\n\t\t\t.then(() => auction.announceClosed())\n\t\t\t.then(() => application.showsSniperHasLostAuction());\n\t});\n\t\n\tit('sniper makes a higher bid but loses', () => {\n\t\treturn auction.startSellingItem()\n\t\t\t.then(() => application.startBiddingIn('item-5347'))\n\t\t\t.then(() => auction.hasRecievedJoinRequestFromSniper())\n\n\t\t\t.then(() => auction.reportPrice(1000, 98, \"other bidder\"))\n\t\t\t.then(() => application.hasShownSniperIsBidding())\n\n\t\t\t.then(() => auction.hasReceivedBid(1098, SNIPER_ID))\n\n\t\t\t.then(() => auction.announceClosed())\n\t\t\t.then(() => application.showsSniperHasLostAuction());\n\t});\n\n\n\tit('sniper wins an auction by bidding higher', () => {\n\t\treturn auction.startSellingItem()\n\t\t\t.then(() => application.startBiddingIn('item-5347'))\n\t\t\t.then(() => auction.hasRecievedJoinRequestFromSniper())\n\n\t\t\t.then(() => auction.reportPrice(1000, 98, \"other bidder\"))\n\t\t\t.then(() => application.hasShownSniperIsBidding())\n\n\t\t\t.then(() => auction.hasReceivedBid(1098, SNIPER_ID))\n\n\t\t\t.then(() => auction.reportPrice(1098, 97, SNIPER_ID))\n\t\t\t.then(() => application.hasShownSniperIsWinning())\n\n\t\t\t.then(() => auction.announceClosed())\n\t\t\t.then(() => application.showsSniperHasWonAuction());\n\t});\n\n\tafterEach('stop application', () => {\n\t\tapplication.stop();\n\t});\n});"],"sourceRoot":"/source/"}